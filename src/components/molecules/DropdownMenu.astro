---
/* eslint-disable no-unused-vars */
export interface DropdownMenuItem {
  id: string;
  label: string;
  href?: string;
  icon?: string;
  disabled?: boolean;
  divider?: boolean;
  onClick?: () => void;
}

export interface DropdownMenuGroup {
  id: string;
  label?: string;
  items: DropdownMenuItem[];
}

export interface Props {
  trigger: {
    label: string;
    icon?: string;
    variant?: 'button' | 'link' | 'icon';
    size?: 'sm' | 'md' | 'lg';
  };
  items: DropdownMenuItem[] | DropdownMenuGroup[];
  placement?: 'bottom-start' | 'bottom-end' | 'top-start' | 'top-end';
  variant?: 'default' | 'compact';
  size?: 'sm' | 'md' | 'lg';
  disabled?: boolean;
  open?: boolean;
  onToggle?: (isOpen: boolean) => void;
  onItemClick?: (item: DropdownMenuItem) => void;
}

const {
  trigger,
  items,
  placement = 'bottom-start',
  variant = 'default',
  size = 'md',
  disabled = false,
  open = false,
} = Astro.props;

const menuId = `dropdown-menu-${trigger.label.toLowerCase().replace(/\s+/g, '-')}`;
const triggerId = `${menuId}-trigger`;
const isGrouped = items.length > 0 && 'items' in items[0];
const isOpen = open && !disabled;
const hasIcon = !!trigger.icon;
const hasLabel = !!trigger.label;
const isIconOnly = trigger.variant === 'icon' && !hasLabel;

// Helper function to get item classes
const getItemClasses = (item: DropdownMenuItem) => {
  const baseClasses = 'dropdown-menu-item';
  const stateClasses = item.disabled
    ? 'disabled'
    : item.divider
      ? 'divider'
      : 'clickable';
  const sizeClasses = `size-${size}`;
  return `${baseClasses} ${stateClasses} ${sizeClasses}`;
};
---

<div
  class="dropdown-menu"
  data-placement={placement}
  data-variant={variant}
  data-size={size}
>
  <button
    id={triggerId}
    type="button"
    class:list={[
      'dropdown-trigger',
      `variant-${trigger.variant || 'button'}`,
      `size-${trigger.size || size}`,
      { disabled, 'has-icon': hasIcon, 'icon-only': isIconOnly },
    ]}
    aria-haspopup="true"
    aria-expanded={isOpen}
    aria-controls={menuId}
    disabled={disabled}
    aria-label={isIconOnly ? trigger.label : undefined}
  >
    {
      hasIcon && (
        <span class="trigger-icon" aria-hidden="true">
          {trigger.icon}
        </span>
      )
    }
    {hasLabel && <span class="trigger-label">{trigger.label}</span>}
    <span class="trigger-chevron" aria-hidden="true">â–¼</span>
  </button>

  {
    isOpen && (
      <div
        id={menuId}
        class="dropdown-menu-panel"
        role="menu"
        aria-labelledby={triggerId}
        aria-orientation="vertical"
      >
        {isGrouped
          ? // Grouped items
            (items as DropdownMenuGroup[]).map((group) => (
              <div class="dropdown-menu-group">
                {group.label && (
                  <div class="dropdown-menu-group-label" role="presentation">
                    {group.label}
                  </div>
                )}
                {group.items.map((item) => (
                  <div class={getItemClasses(item)} role="none">
                    {item.divider ? (
                      <hr class="dropdown-menu-divider" role="separator" />
                    ) : (
                      <a
                        href={item.href || '#'}
                        class="dropdown-menu-item-link"
                        role="menuitem"
                        aria-disabled={item.disabled}
                        tabindex={item.disabled ? -1 : 0}
                        onclick={
                          item.onClick
                            ? `(${item.onClick.toString()})()`
                            : undefined
                        }
                      >
                        {item.icon && (
                          <span class="item-icon" aria-hidden="true">
                            {item.icon}
                          </span>
                        )}
                        <span class="item-label">{item.label}</span>
                      </a>
                    )}
                  </div>
                ))}
              </div>
            ))
          : // Flat items
            (items as DropdownMenuItem[]).map((item) => (
              <div class={getItemClasses(item)} role="none">
                {item.divider ? (
                  <hr class="dropdown-menu-divider" role="separator" />
                ) : (
                  <a
                    href={item.href || '#'}
                    class="dropdown-menu-item-link"
                    role="menuitem"
                    aria-disabled={item.disabled}
                    tabindex={item.disabled ? -1 : 0}
                    onclick={
                      item.onClick
                        ? `(${item.onClick.toString()})()`
                        : undefined
                    }
                  >
                    {item.icon && (
                      <span class="item-icon" aria-hidden="true">
                        {item.icon}
                      </span>
                    )}
                    <span class="item-label">{item.label}</span>
                  </a>
                )}
              </div>
            ))}
      </div>
    )
  }
</div>

<style>
  .dropdown-menu {
    position: relative;
    display: inline-block;
    font-family: var(--font-family-base);
  }

  .dropdown-trigger {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: var(--border-width-sm) var(--border-style-solid)
      var(--color-border-default);
    border-radius: var(--radius-md);
    background: var(--color-background-surface);
    color: var(--color-text-body);
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-regular);
    cursor: pointer;
    transition: all var(--transition-duration-fast);
    text-decoration: none;
    min-height: var(--space-lg);
  }

  .dropdown-trigger:focus-visible {
    outline: var(--outline-width-sm) var(--border-style-solid)
      var(--color-border-focus);
    outline-offset: var(--space-2xs);
  }

  .dropdown-trigger:hover:not(.disabled) {
    background: var(--color-surface);
    border-color: var(--color-border-focus);
  }

  .dropdown-trigger.disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .dropdown-trigger.has-icon {
    padding-left: var(--space-sm);
  }

  .dropdown-trigger.icon-only {
    padding: var(--space-sm);
    min-width: var(--space-lg);
    justify-content: center;
  }

  .trigger-icon {
    font-size: var(--font-size-lg);
    color: var(--color-text-subtle);
  }

  .trigger-label {
    color: var(--color-text-body);
  }

  .trigger-chevron {
    font-size: var(--font-size-xs);
    color: var(--color-text-subtle);
    transition: transform var(--transition-duration-fast);
  }

  .dropdown-trigger[aria-expanded='true'] .trigger-chevron {
    transform: rotate(180deg);
  }

  /* Variant styles */
  .dropdown-trigger.variant-link {
    border: none;
    background: transparent;
    padding: var(--space-xs) var(--space-sm);
    color: var(--color-interactive-primary);
  }

  .dropdown-trigger.variant-link:hover:not(.disabled) {
    background: var(--color-background-accent);
    color: var(--color-interactive-primary-hover);
  }

  .dropdown-trigger.variant-icon {
    border: none;
    background: transparent;
    padding: var(--space-sm);
    color: var(--color-text-subtle);
  }

  .dropdown-trigger.variant-icon:hover:not(.disabled) {
    background: var(--color-background-accent);
    color: var(--color-text-body);
  }

  /* Size styles */
  .dropdown-trigger.size-sm {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    min-height: var(--space-md);
  }

  .dropdown-trigger.size-lg {
    padding: var(--space-md) var(--space-lg);
    font-size: var(--font-size-lg);
    min-height: var(--space-xl);
  }

  .dropdown-menu-panel {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: var(--size-dropdown-width-md);
    background: var(--color-background-surface);
    border: var(--border-width-sm) var(--border-style-solid)
      var(--color-border-default);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    margin-top: var(--space-xs);
    padding: var(--space-xs) 0;
    max-height: var(--size-dropdown-width-lg);
    overflow-y: auto;
  }

  .dropdown-menu[data-placement='bottom-end'] .dropdown-menu-panel {
    left: auto;
    right: 0;
  }

  .dropdown-menu[data-placement='top-start'] .dropdown-menu-panel {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: var(--space-xs);
  }

  .dropdown-menu[data-placement='top-end'] .dropdown-menu-panel {
    inset: auto auto 100% 0;
    margin-top: 0;
    margin-bottom: var(--space-xs);
  }

  .dropdown-menu-item {
    position: relative;
  }

  .dropdown-menu-item.clickable:hover {
    background: var(--color-background-accent);
  }

  .dropdown-menu-item.disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .dropdown-menu-item-link {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    color: var(--color-text-body);
    text-decoration: none;
    width: 100%;
    transition: background-color var(--transition-duration-fast);
  }

  .dropdown-menu-item-link:focus-visible {
    outline: var(--outline-width-sm) var(--border-style-solid)
      var(--color-border-focus);
    outline-offset: var(--space-2xs);
  }

  .dropdown-menu-item.disabled .dropdown-menu-item-link {
    color: var(--color-text-subtle);
    cursor: not-allowed;
  }

  /* Variant styles */
  .dropdown-menu[data-variant='compact'] .dropdown-menu-panel {
    padding: var(--space-2xs) 0;
  }

  .dropdown-menu[data-variant='compact'] .dropdown-menu-item-link {
    padding: var(--space-xs) var(--space-sm);
  }

  /* Size styles */
  .dropdown-menu[data-size='sm'] .dropdown-menu-panel {
    min-width: var(--size-dropdown-width-sm);
  }

  .dropdown-menu[data-size='sm'] .dropdown-menu-item-link {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
  }

  .dropdown-menu[data-size='lg'] .dropdown-menu-panel {
    min-width: var(--size-dropdown-width-ml);
  }

  .dropdown-menu[data-size='lg'] .dropdown-menu-item-link {
    padding: var(--space-md) var(--space-lg);
    font-size: var(--font-size-lg);
  }

  .dropdown-menu-item.clickable .dropdown-menu-item-link:hover {
    background: var(--color-background-accent);
  }

  .item-icon {
    font-size: var(--font-size-md);
    color: var(--color-text-subtle);
    width: var(--space-md);
    text-align: center;
  }

  .item-label {
    flex: 1;
    color: var(--color-text-body);
  }

  .dropdown-menu-divider {
    margin: var(--space-xs) 0;
    border: none;
    border-top: var(--border-width-sm) var(--border-style-solid)
      var(--color-border-subtle);
  }

  .dropdown-menu-group {
    margin-bottom: var(--space-xs);
  }

  .dropdown-menu-group:last-child {
    margin-bottom: 0;
  }

  .dropdown-menu-group-label {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-regular);
    color: var(--color-text-subtle);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-lg);
  }
</style>
